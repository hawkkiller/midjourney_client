name: Code Quality

on:
  push:
      branches: [main]    

  pull_request:
      branches: [main]

jobs:
  analyze:
      name: Code Quality
      runs-on: ubuntu-latest
      steps:
          - name: ğŸ”„ Checkout
            uses: actions/checkout@v3

          - name: ğŸ”§ Dart Setup
            uses: dart-lang/setup-dart@v1
            with:
              sdk: "3.0.5"

          - name: ğŸ“¦ Get Packages
            run: dart pub get

          - name: ğŸ” Analyze
            run: dart analyze --fatal-infos --fatal-warnings .

          - name: ğŸ“ Format
            run: dart format --set-exit-if-changed .
            
          - name: âœ… Validate
            run: dart pub publish --dry-run
          
          - name: ğŸ§ª Run tests
            timeout-minutes: 2
            run: |
              dart run coverage:test_with_coverage -fb -o coverage -- \
                --concurrency=6 --platform vm --coverage=./coverage --reporter=expanded test/midjourney_client_test.dart
          
          - name: ğŸ“¥ Upload coverage to Codecov
            timeout-minutes: 1
            uses: codecov/codecov-action@v3
